<%- include("partials/header") %>

<section class="panel glass-panel">
  <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Invite details</p>
  <h2 class="mt-2 text-2xl font-semibold text-[#c8ccd4]">Your thoughtful invite</h2>
  <div class="status-banner status-<%= invite.status %> mt-4">
    Status: <strong><%= invite.status %></strong>
  </div>

  <div class="detail-grid mt-6">
    <div class="glass-card p-5">
      <h3 class="text-sm uppercase tracking-[0.3em] text-slate-400">Recipient</h3>
      <p class="mt-2 text-slate-200"><%= invite.recipient.name %> (#<%= invite.recipient.rollNumber %>)</p>
    </div>
    <div class="glass-card p-5">
      <h3 class="text-sm uppercase tracking-[0.3em] text-slate-400">Why you?</h3>
      <p class="mt-2 text-slate-200"><%= invite.whyYou || "—" %></p>
    </div>
    <div class="glass-card p-5">
      <h3 class="text-sm uppercase tracking-[0.3em] text-slate-400">Who I am (without my name)</h3>
      <p class="mt-2 text-slate-200">Green flag: <%= invite.about?.greenFlag || "—" %></p>
      <p class="mt-2 text-slate-200">Passion: <%= invite.about?.passion || "—" %></p>
      <p class="mt-2 text-slate-200">Trait: <%= invite.about?.trait || "—" %></p>
    </div>
    <div class="glass-card p-5">
      <h3 class="text-sm uppercase tracking-[0.3em] text-slate-400">The message</h3>
      <p class="mt-2 text-slate-200"><%= invite.message %></p>
    </div>
    <div class="glass-card p-5">
      <h3 class="text-sm uppercase tracking-[0.3em] text-slate-400">Response</h3>
      <% if (invite.status === "pending") { %>
      <p class="mt-2 muted">Waiting for response.</p>
      <% } else { %>
      <p class="mt-2 text-slate-200">Feeling: <%= invite.response?.feeling || "—" %></p>
      <p class="mt-2 text-slate-200">What stood out: <%= invite.response?.standout || "—" %></p>
      <p class="mt-2 text-slate-200">Open to connect: <%= invite.response?.openness || "—" %></p>
      <% if (invite.response?.openness === "yes") { %>
      <% if (invite.response?.contactMethod === "phone") { %>
      <p class="mt-2 text-slate-200">Phone: <%= invite.response?.phone || "—" %></p>
      <% } %>
      <% if (invite.response?.contactMethod === "insta") { %>
      <p class="mt-2 text-slate-200">Instagram: <%= invite.response?.insta || "—" %></p>
      <% } %>
      <% if (invite.response?.contactMethod === "followup") { %>
      <p class="mt-2 text-slate-200">Follow-up: One more anonymous message requested.</p>
      <% } %>
      <% } %>
      <% } %>
    </div>
  </div>

  <% if (invite.status === "pending") { %>
  <div class="divider"></div>
  <h3 class="text-lg font-semibold text-[#c8ccd4]">Edit invite (pending only)</h3>
  <form class="form" action="/invites/<%= invite._id %>/edit" method="POST">
    <label>
      Section A — Why You?
      <textarea name="whyYou" rows="3" required maxlength="220" class="textarea-field"><%= invite.whyYou || "" %></textarea>
    </label>
    <label>
      One green flag about me
      <input type="text" name="greenFlag" required maxlength="120" class="input-field" value="<%= invite.about?.greenFlag || "" %>" />
    </label>
    <label>
      One thing I’m genuinely passionate about
      <input type="text" name="passion" required maxlength="120" class="input-field" value="<%= invite.about?.passion || "" %>" />
    </label>
    <label>
      One honest (but respectful) trait
      <input type="text" name="trait" required maxlength="120" class="input-field" value="<%= invite.about?.trait || "" %>" />
    </label>
    <label>
      Section C — The Message
      <textarea name="message" rows="4" required maxlength="600" class="textarea-field"><%= invite.message %></textarea>
    </label>
    <button class="btn btn-primary" type="submit">Update invite</button>
  </form>
  <% } %>

  <% if (invite.status !== "pending") { %>
  <div class="divider"></div>
  <h3 class="text-lg font-semibold text-[#c8ccd4]">Follow-up messages</h3>
  <% const canFollowup = invite.response?.contactMethod === "followup" || (invite.followups || []).some((entry) => entry.response?.allowFollowup); %>
  <% if (canFollowup) { %>
  <a class="btn btn-outline mt-3" href="/invites/<%= invite._id %>/followup">Send an anonymous follow-up</a>
  <% } else { %>
  <p class="muted mt-2">They haven’t requested another anonymous message yet.</p>
  <% } %>
  <% if (invite.followups && invite.followups.length) { %>
  <div class="detail-grid mt-4">
    <% invite.followups.forEach((entry) => { %>
    <div class="glass-card p-5">
      <h4 class="text-sm uppercase tracking-[0.3em] text-slate-400">Your follow-up</h4>
      <p class="mt-2 text-slate-200"><%= entry.message %></p>
      <% if (entry.response && entry.response.message) { %>
      <div class="divider"></div>
      <h4 class="text-sm uppercase tracking-[0.3em] text-slate-400">Their response</h4>
      <p class="mt-2 text-slate-200"><%= entry.response.message %></p>
      <% if (entry.response.contactMethod === "phone") { %>
      <p class="mt-2 text-slate-200">Phone: <%= entry.response.phone || "—" %></p>
      <% } %>
      <% if (entry.response.contactMethod === "insta") { %>
      <p class="mt-2 text-slate-200">Instagram: <%= entry.response.insta || "—" %></p>
      <% } %>
      <% if (entry.response.contactMethod === "followup") { %>
      <p class="mt-2 text-slate-200">Follow-up: One more anonymous message requested.</p>
      <% } %>
      <% } else { %>
      <p class="mt-2 muted">Waiting for a response.</p>
      <% } %>
    </div>
    <% }) %>
  </div>
  <% } %>
  <% } %>
</section>

<%- include("partials/footer") %>

