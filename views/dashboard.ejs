<%- include("partials/header") %>

<%
  const counts = invites.reduce(
    (acc, invite) => {
      acc.total += 1;
      if (invite.status === "accepted") acc.accepted += 1;
      if (invite.status === "rejected") acc.rejected += 1;
      if (invite.status === "pending") acc.pending += 1;
      return acc;
    },
    { total: 0, pending: 0, accepted: 0, rejected: 0 }
  );
%>

<div class="flex flex-wrap items-start justify-between gap-6">
  <div>
    <p class="text-xs uppercase tracking-[0.3em] text-white/50">Dashboard</p>
    <h2 class="mt-2 text-3xl font-semibold text-white">The Control Room</h2>
    <p class="mt-2 text-sm text-white/60">Search, send, and track your prom invites.</p>
  </div>
  <div class="flex flex-wrap gap-2 text-xs text-white/60">
    <span class="rounded-full border border-white/10 bg-white/5 px-3 py-1">Anonymous</span>
    <span class="rounded-full border border-white/10 bg-white/5 px-3 py-1">Dark Euphoria</span>
    <span class="rounded-full border border-white/10 bg-white/5 px-3 py-1">Email updates</span>
  </div>
</div>

<div class="mt-8 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
  <div class="rounded-2xl border border-white/10 bg-white/5 p-4 backdrop-blur-xl">
    <div class="text-xs text-white/50">Total invites</div>
    <div class="mt-2 text-2xl font-semibold"><%= counts.total %></div>
  </div>
  <div class="rounded-2xl border border-amber-400/30 bg-white/5 p-4 backdrop-blur-xl">
    <div class="text-xs text-white/50">Pending</div>
    <div class="mt-2 text-2xl font-semibold text-amber-300"><%= counts.pending %></div>
  </div>
  <div class="rounded-2xl border border-emerald-400/30 bg-white/5 p-4 backdrop-blur-xl">
    <div class="text-xs text-white/50">Accepted</div>
    <div class="mt-2 text-2xl font-semibold text-emerald-300"><%= counts.accepted %></div>
  </div>
  <div class="rounded-2xl border border-red-500/30 bg-white/5 p-4 backdrop-blur-xl">
    <div class="text-xs text-white/50">Rejected</div>
    <div class="mt-2 text-2xl font-semibold text-red-300"><%= counts.rejected %></div>
  </div>
</div>

<div class="mt-10 grid gap-6 lg:grid-cols-[320px_1fr]">
  <aside class="rounded-2xl border border-white/10 bg-white/5 p-5 backdrop-blur-xl">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold">Invitations</h3>
      <span class="text-xs text-white/50"><%= counts.total %> total</span>
    </div>
    <p class="mt-1 text-xs text-white/50">Track who replied and what they said.</p>
    <div class="mt-4 flex flex-col gap-3">
      <% if (invites.length === 0) { %>
      <div class="rounded-xl border border-dashed border-white/10 bg-black/30 p-4">
        <h4 class="text-sm font-semibold">No invites yet</h4>
        <p class="mt-1 text-xs text-white/60">Search a student on the right to start.</p>
      </div>
      <% } %>
      <% invites.forEach((invite) => { %>
      <%
        const statusClass =
          invite.status === "accepted"
            ? "border-emerald-400/40"
            : invite.status === "rejected"
            ? "border-red-500/40 opacity-70"
            : "border-amber-400/40";
        const dotClass =
          invite.status === "accepted"
            ? "bg-emerald-400"
            : invite.status === "rejected"
            ? "bg-red-400"
            : "bg-amber-400 animate-pulse";
      %>
      <a
        class="group rounded-2xl border border-white/10 bg-black/40 p-4 transition hover:border-white/30 <%= statusClass %>"
        href="/invites/<%= invite._id %>"
      >
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold"><%= invite.recipient.name %></div>
          <span class="h-2.5 w-2.5 rounded-full <%= dotClass %>"></span>
        </div>
        <div class="mt-2 flex items-center justify-between text-xs text-white/60">
          <span>#<%= invite.recipient.rollNumber %></span>
          <span class="rounded-full border border-white/10 bg-white/5 px-2 py-0.5 capitalize"><%= invite.status %></span>
        </div>
      </a>
      <% }) %>
    </div>
  </aside>

  <section>
    <div class="rounded-3xl border border-white/10 bg-white/5 p-8 text-center shadow-[0_30px_80px_rgba(0,0,0,0.6)] backdrop-blur-2xl">
      <p class="text-xs uppercase tracking-[0.35em] text-white/50">Spotlight Search</p>
      <h2 class="mt-3 text-2xl font-semibold text-white">Who caught your eye?</h2>
      <p class="mt-2 text-sm text-white/60">Search by name or roll number, then press Enter.</p>
      <div class="mt-6 rounded-2xl border border-white/10 bg-black/40 px-4 py-3 focus-within:border-[#ff0055]/60 focus-within:ring-2 focus-within:ring-[#ff0055]/30">
        <input
          id="studentSearch"
          type="text"
          placeholder="Who caught your eye? (Name or Roll No)"
          autocomplete="off"
          class="w-full bg-transparent text-base text-white placeholder:text-white/40 focus:outline-none"
        />
        <input id="studentId" type="hidden" />
      </div>
      <div id="results" class="mt-4 space-y-2"></div>
      <p class="mt-3 text-xs text-white/50">Tip: use roll number for the fastest match.</p>
    </div>
  </section>
</div>

<script>
  const searchInput = document.getElementById("studentSearch");
  const studentIdInput = document.getElementById("studentId");
  const resultsEl = document.getElementById("results");

  let activeIndex = -1;
  let currentResults = [];

  function renderResults(items) {
    resultsEl.innerHTML = "";
    items.forEach((item, index) => {
      const row = document.createElement("div");
      row.className =
        "cursor-pointer rounded-xl border border-white/10 bg-black/40 px-4 py-2 text-left text-sm text-white/80 transition hover:border-white/30 hover:bg-white/5";
      row.textContent = `${item.name} (${item.rollNumber})`;
      row.addEventListener("click", () => selectResult(index));
      if (index === activeIndex) {
        row.classList.add("border-[#ff0055]/60", "bg-white/10");
      }
      resultsEl.appendChild(row);
    });
  }

  function selectResult(index) {
    const selected = currentResults[index];
    if (!selected) return;
    studentIdInput.value = selected._id;
    searchInput.value = `${selected.name} (${selected.rollNumber})`;
    resultsEl.innerHTML = "";
  }

  searchInput.addEventListener("input", async (e) => {
    const query = e.target.value.trim();
    studentIdInput.value = "";
    activeIndex = -1;
    if (!query) {
      resultsEl.innerHTML = "";
      return;
    }
    const res = await fetch(`/api/students?query=${encodeURIComponent(query)}`);
    const data = await res.json();
    currentResults = data;
    renderResults(data);
  });

  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "ArrowDown") {
      activeIndex = Math.min(activeIndex + 1, currentResults.length - 1);
      renderResults(currentResults);
    }
    if (e.key === "ArrowUp") {
      activeIndex = Math.max(activeIndex - 1, 0);
      renderResults(currentResults);
    }
    if (e.key === "Enter") {
      if (!studentIdInput.value && currentResults[activeIndex]) {
        selectResult(activeIndex);
      }
      if (studentIdInput.value) {
        window.location.href = `/invites/new?studentId=${studentIdInput.value}`;
      }
    }
  });
</script>

<%- include("partials/footer") %>

