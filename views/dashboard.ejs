<%- include("partials/header") %>

<div class="dashboard">
  <aside class="sidebar glass-panel">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold text-[#c8ccd4]">Invitations</h3>
      <span class="text-xs text-slate-400">Your tickets</span>
    </div>
    <div class="stats-card glass-card">
      <div>
        <div class="stat-label">Confessions sent</div>
        <div class="stat-value"><%= stats.totalSent %></div>
      </div>
      <div>
        <div class="stat-label">Accepted</div>
        <div class="stat-value accent"><%= stats.accepted %></div>
      </div>
    </div>
    <div class="sidebar-list">
      <% if (invites.length === 0) { %>
      <div class="muted">No invites yet.</div>
      <% } %>
      <% invites.forEach((invite) => { %>
      <a class="invite-card status-<%= invite.status %>" href="/invites/<%= invite._id %>">
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold text-slate-100"><%= invite.recipient.name %></div>
          <span class="status-dot"></span>
        </div>
        <div class="invite-meta">
          <span>#<%= invite.recipient.rollNumber %></span>
          <span class="uppercase tracking-[0.3em] text-[10px]"><%= invite.status %></span>
        </div>
        <% if (invite.status === "accepted") { %>
        <div class="mt-3">
          <span class="btn btn-primary btn-mini">Reveal Contact</span>
        </div>
        <% const canFollowup = invite.response?.contactMethod === "followup" || (invite.followups || []).some((entry) => entry.response?.allowFollowup); %>
        <% if (canFollowup) { %>
        <div class="mt-2">
          <span class="btn btn-outline btn-mini">Send follow-up</span>
        </div>
        <% } %>
        <% } %>
      </a>
      <% }) %>
    </div>
  </aside>

  <section class="content">
    <div class="search-card glass-panel w-full max-w-2xl text-center">
      <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Magic Search</p>
      <h2 class="mt-3 text-2xl font-semibold text-[#c8ccd4]">Who caught your eye?</h2>
      <p class="mt-2 text-sm text-slate-300">
        Find their profile and send a confession before someone else does.
      </p>
      <div class="spotlight-wrap">
        <input
          id="studentSearch"
          type="text"
          class="spotlight-input"
          placeholder="Who caught your eye? (Name or Roll No)"
          autocomplete="off"
        />
        <input id="studentId" type="hidden" />
      </div>
      <div id="results" class="results"></div>
      <div class="manual-card glass-card">
        <div class="manual-title">Can't find them?</div>
        <div class="manual-subtitle">Add their roll number + name to continue.</div>
        <div class="manual-grid">
          <input id="manualRoll" type="text" class="input-field" placeholder="Roll number" />
          <input id="manualName" type="text" class="input-field" placeholder="Full name" />
        </div>
        <button id="manualSubmit" class="btn btn-outline" type="button">
          Add &amp; Send
        </button>
        <div id="manualError" class="manual-error"></div>
      </div>
      <p class="muted tiny mt-3">Select a student, then press Enter to create a request.</p>
    </div>
  </section>
</div>

<script>
  const searchInput = document.getElementById("studentSearch");
  const studentIdInput = document.getElementById("studentId");
  const resultsEl = document.getElementById("results");
  const manualRollInput = document.getElementById("manualRoll");
  const manualNameInput = document.getElementById("manualName");
  const manualSubmit = document.getElementById("manualSubmit");
  const manualError = document.getElementById("manualError");

  let activeIndex = -1;
  let currentResults = [];

  function renderResults(items) {
    resultsEl.innerHTML = "";
    items.forEach((item, index) => {
      const row = document.createElement("div");
      row.className = "result-item";
      const meta = item.rollNumber || item.email || "No roll number";
      row.textContent = `${item.name} (${meta})`;
      row.addEventListener("click", () => selectResult(index));
      if (index === activeIndex) row.classList.add("active");
      resultsEl.appendChild(row);
    });
  }

  function selectResult(index) {
    const selected = currentResults[index];
    if (!selected) return;
    studentIdInput.value = selected._id;
    searchInput.value = `${selected.name} (${selected.rollNumber || selected.email || ""})`;
    resultsEl.innerHTML = "";
    window.location.href = `/invites/new?studentId=${selected._id}`;
  }

  searchInput.addEventListener("input", async (e) => {
    const query = e.target.value.trim();
    studentIdInput.value = "";
    activeIndex = -1;
    if (!query) {
      resultsEl.innerHTML = "";
      return;
    }
    const res = await fetch(`/api/students?query=${encodeURIComponent(query)}`);
    const data = await res.json();
    currentResults = data;
    renderResults(data);
  });

  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "ArrowDown") {
      activeIndex = Math.min(activeIndex + 1, currentResults.length - 1);
      renderResults(currentResults);
    }
    if (e.key === "ArrowUp") {
      activeIndex = Math.max(activeIndex - 1, 0);
      renderResults(currentResults);
    }
    if (e.key === "Enter") {
      if (!studentIdInput.value && currentResults[activeIndex]) {
        selectResult(activeIndex);
      }
    }
  });

  manualSubmit.addEventListener("click", async () => {
    manualError.textContent = "";
    const rollNumber = manualRollInput.value.trim();
    const name = manualNameInput.value.trim();
    if (!rollNumber || !name) {
      manualError.textContent = "Please enter both roll number and name.";
      return;
    }
    manualSubmit.disabled = true;
    try {
      const res = await fetch("/api/students/manual", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rollNumber, name })
      });
      const data = await res.json();
      if (!res.ok) {
        manualError.textContent = data.error || "Could not add student.";
        return;
      }
      window.location.href = `/invites/new?studentId=${data._id}`;
    } catch (err) {
      manualError.textContent = "Network error. Please try again.";
    } finally {
      manualSubmit.disabled = false;
    }
  });
</script>

<%- include("partials/footer") %>

